---
title: 使用SSH隧道和内网渗透访问家中服务器
date: 2018-10-23 12:36:00
tags: Linux
---
场景如下，家中有一台自己攒的Linux电脑，有时候需要学习一些东西，都在那台电脑上进行，比如研究k8s，可以在上面搭建环境。但是问题是，在出了家里局域网，想要外网访问相对麻烦，且虽然有一些成熟的内网解决方案，但是因为不像直接暴露机器到DMZ，每个内网渗透一般只能绑定一个端口，而我们很多时候需要用的端口是不固定，且多个。这时候为每个端口买个渗透明显就不划算了。所以本文记录现在自己使用的一种解决方案
> Natapp做内网渗透 + SSH隧道解决多端口问题

<!--more-->
## 0x01 内网渗透
***
内网渗透推荐这样一款工具：Natapp，[官网](https://natapp.cn/)，其功能类似ngrok，不过给你提供了公网的机器，你要做的就是在其控制界面配置一下本地服务端口，选协议，然后在本地机器上启动对应服务即可。
针对不同场景、流量需求，natapp提供了多种套餐，如下。因为自己只是访问家中电脑方面控制，所以买了个最低配即可：
![](/images/20181023/natapp_services.png)
。使用方式官网也有教程: [连接](https://natapp.cn/article/nohup)，使用命令启动即可，同时传递参数authtoken，其在购买服务之后可以在管理界面查询到，如下：
![](/images/20181023/natapp_webconsole.png)
注意其协议有两种，TCP和HTTP，因为这里是配合SSH隧道使用，所以选择TCP，端口则是你SSH服务监听的端口(默认22)

## 0x02 通过supervisor配置服务
***
既然家里电脑是当做服务器使用，当然希望的是自己想使用的时候就能提供服务，虽然一直开机可以满足，但是又明显没有必要（费电）。所以后面可以使用比如小米的智能插座，配合BIOS通电自动开机来实现远程的开机，又或者使用WOL之类方案来进行网络唤醒。这就得另说了。但是首先我们需要解决的问题是，如何让Natapp开机启动。
虽然你可以通过编写开机启动脚本来实现，但是之前博客介绍过Supervisor，所以我们可以直接使用Supervisor来进行服务的自动启动，启停控制等。具体Supervisor参考之前博客。这里只记录natapp的配置：
```ini
[program:natapp]
command=/opt/natapp/natapp -authtoken=<your_authtoken> -log=stdout
autostart=true
autorestart=true
stdout_logfile=/tmp/natapp.log
```

> 注意这里需要换上你自己的authtoken，包括natapp命令，也需要替换为你实际的程序路径

## 0x03 SSH隧道
***
SSH隧道是什么这里就不记录了。这里我们主要通过SSH隧道来解决多端口的问题。简单理解就是虽然我们是访问不同端口，但是我们可以配置一个本地端口和远程机器的端口映射，然后通过SSH隧道来建立连接。
命令行的方式并不方便，我这里使用的是OSX系统，所以推荐一个免费的SSH隧道管理的GUI工具[SSH Tunnel Manager](https://www.tynsoe.org/v2/stm/)
![](/images/20181023/ssh_tunnel_manager.png)
其界面大致如下，我们配置好远程机器，及端口映射即可
![](/images/20181023/ssh_tunnel_config.png)
> 注：按照你自己的连接信息配置

以Tomcat为例，我们先通过ssh透过natapp访问远程机器，启动Tomcat，然后因为上面透过SSH隧道已经建立了映射，所以我们直接访问本地端口，就能看到远程机器的Tomcat服务了
![](/images/20181023/tomcat_webui.png)

## 0x04 总结
***
这个方案是现在自己用的方案，虽然还是需要花一定的费用来进行内网渗透，但是其实你也可以使用ngrok来实现类似的效果，当然如果你有外网服务器的话。但是如果专门为了内网渗透买一个有公网ip的服务器，也不一定很划算。另外，如果你家中网络是电信或者联通的话（有公网ip），可以考虑直接用路由器的端口转发来进行SSH服务的暴露，只不过因为我家中网络因素，无法走这条路。综上，SSH隧道还是很方便的一个东西，你可以随时配置一个隧道来访问服务器上对应的服务，而不需要再额外考虑成本、部署渗透等因素。

